# compare_structures Tool

The `compare_structures.py` tool compares two file structure YAML files (generated by `verify_file_structure.py`) to identify differences in organization, file existence, and content similarity.

## Core Functionality

- **Hierarchical Comparison**: Compares file structures at multiple levels
- **Content Fingerprinting**: Uses embeddings to detect changes in file content
- **Multiple Output Formats**: Supports YAML, JSON, and text outputs
- **Tolerance Settings**: Handles numerical differences with customizable tolerance
- **Comprehensive Reporting**: Provides detailed information about differences

## Comparison Levels

The tool performs a systematic comparison at multiple levels:

1. **Sections**: Major categories of files (e.g., "illumination_files")
2. **Sets**: Groups of folders within sections
3. **Folders**: Directory paths containing files
4. **Types**: Semantic file types (e.g., "metadata_csv")
5. **Files**: Individual files and their properties

## Usage

```bash
python compare_structures.py [options] <first_yaml> <second_yaml>
```

### Options

- `-o, --output-file <file>`: Output file for comparison results (default: stdout)
- `--output-format <format>`: Format for output (yaml, json, or text; default: yaml)
- `--compare-embeddings/--no-compare-embeddings`: Whether to compare file embeddings (default: False)
- `--tolerance <value>`: Tolerance for numerical differences in embeddings (default: 0.0)

## Output Format

The comparison output includes:

- Overall comparison status (identical, possibly_identical, different_sections, different_content)
- Timestamp of comparison
- Section-by-section comparison details
- Specific differences at each level of comparison
- File-by-file differences when detected

## Examples

### Basic Comparison

```bash
python compare_structures.py first.yaml second.yaml -o comparison_report.yaml
```

### Human-Readable Output

```bash
python compare_structures.py first.yaml second.yaml \
  --output-format text \
  --output-file comparison_report.txt
```

### Content-Aware Comparison

```bash
python compare_structures.py first.yaml second.yaml \
  --compare-embeddings \
  --tolerance 0.01 \
  --output-file comparison_report.yaml
```

## Example Output (Text Format)

```
Comparison Report
=================
Status: different_content
Timestamp: 2023-05-15T14:30:00

Section: illumination_files
  Status: different_content
  Set: plate1
    Status: different_content
    Folder: Batch1/Plate1
      Status: different_content
      Type: illumination_file
        Status: different_content
        File: illum_corr_DAPI.npy
          Status: different_content
          Reason: Content differs (embedding similarity: 0.92)
```

## Usage in Pipeline Validation

In the pipeline validation process, `compare_structures.py` is used primarily in Stages 4-5 to:

1. Compare StarryNight output structures with reference output structures
2. Generate detailed reports highlighting any discrepancies
3. Provide both machine-readable (YAML/JSON) and human-readable (text) results

For detailed usage examples, refer to the individual pipeline validation documents.
